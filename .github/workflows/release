name: Build Release

on:
  # 当创建新的 Release 时触发
  release:
    types: [created]

jobs:
  # 构建任务
  build-linux:
    # 在 Linux 上运行
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # 检出完整历史，确保有标签信息
          fetch-depth: 0
      
      # 2. 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # 使用最新的 LTS 版本
          cache: 'npm'        # 缓存 npm 依赖，加速构建
      
      # 3. 安装依赖
      - name: Install dependencies
        run: npm ci
      
      # 4. 运行构建命令
      - name: Build project
        run: npm run build
        # 如果你的构建命令不是 npm run build，请修改这里
        # 例如：make、yarn build 等
      
      # 5. 创建版本文件（记录版本信息）
      - name: Create version file
        run: |
          echo "Version: ${{ github.ref_name }}" > version.txt
          echo "Build Date: $(date)" >> version.txt
          echo "Commit: ${{ github.sha }}" >> version.txt
          echo "GitHub Run: ${{ github.run_id }}" >> version.txt
      
      # 6. 打包文件
      - name: Create distribution package
        run: |
          # 创建发布目录
          mkdir -p release
          
          # 假设你的构建输出在 dist/ 目录
          # 请根据你的实际项目结构调整
          cp -r dist/* release/ 2>/dev/null || true
          cp -r package.json release/ 2>/dev/null || true
          cp README.md release/ 2>/dev/null || true
          cp LICENSE release/ 2>/dev/null || true
          cp version.txt release/
          
          # 创建压缩包
          cd release
          tar -czf ../myapp-${{ github.ref_name }}-linux-x64.tar.gz .
          
          # 也可以创建 zip 格式（可选）
          zip -r ../myapp-${{ github.ref_name }}-linux-x64.zip .
          
          # 列出文件确认
          echo "Created files:"
          ls -la ../*.tar.gz ../*.zip
      
      # 7. 上传到 Release
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          # 要上传的文件，支持通配符
          files: |
            myapp-${{ github.ref_name }}-linux-x64.tar.gz
            myapp-${{ github.ref_name }}-linux-x64.zip
            # 可以添加其他格式
            # myapp-${{ github.ref_name }}-linux-x64.AppImage
        env:
          # GITHUB_TOKEN 是 GitHub 自动提供的，不需要手动创建
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
